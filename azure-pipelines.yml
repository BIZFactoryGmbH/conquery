trigger:
- master

variables:
  EXCLUDE_SOURCE_MAPS: true
  MVN_CFG: -B -V -Dmaven.repo.local=$(Build.Repository.LocalPath)/cache/.m2
  YARN_CACHE_FOLDER: $(Build.Repository.LocalPath)/cache/yarn/


jobs:
- job: prepare
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: 1ESLighthouseEng.PipelineArtifactCaching.RestoreCacheV1.RestoreCache@1
    inputs:
      keyfile: 'frontend/yarn.lock, **/pom.xml, !**/target/**/pom.xml'
      targetfolder: cache
      vstsFeed: $(ArtifactFeed)
  - task: Maven@3
    displayName: build root
    inputs:
      jdkVersionOption: '1.11'
      goals: install
      options: $(MVN_CFG) -T 1C -N

- job: tests_frontend
  displayName: Frontend Tests
  dependsOn: prepare
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: Maven@3
    displayName: frontend tests
    inputs:
      jdkVersionOption: '1.11'
      goals: install
      options: $(MVN_CFG) -pl frontend-resources

- job: tests_backend
  displayName: Backend Tests
  dependsOn: prepare
  timeoutInMinutes: 15
  pool:
    vmImage: 'ubuntu-16.04'
  steps:   
  - task: Maven@3
    displayName: unit tests
    inputs:
      jdkVersionOption: '1.11'
      goals: install
      options: $(MVN_CFG) -T 1C -pl backend -DexcludedGroups="INTEGRATION_PROGRAMMATIC, INTEGRATION_JSON"

  - task: Maven@3
    displayName: programmatic integration tests
    inputs:
      jdkVersionOption: '1.11'
      goals: test
      options: $(MVN_CFG) -T 1C -pl backend -Dgroups="INTEGRATION_PROGRAMMATIC"

  - task: Maven@3
    displayName: json integration tests
    inputs:
      jdkVersionOption: '1.11'
      goals: test
      options: $(MVN_CFG) -T 1C -pl backend -Dgroups="INTEGRATION_JSON"

- job: save_cache
  displayName: Frontend Tests
  dependsOn:
  - tests_backend
  - tests_frontend
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - task: DeleteFiles@1
    displayName: prepare cache
    inputs:
      sourceFolder: cache/.m2/repository/com/bakdata
      contents: '**'
  - task: 1ESLighthouseEng.PipelineArtifactCaching.SaveCacheV1.SaveCache@1
    inputs:
      keyfile: 'frontend/yarn.lock, **/pom.xml, !**/target/**/pom.xml'
      targetfolder: cache
      vstsFeed: $(ArtifactFeed)